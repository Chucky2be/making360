\section{Optimization Settings}
\pagecolor{white}
\label{chap:35}
\begin{fullwidth}
\groupR{stitch}

\problem

{\large Optimizing quick, advanced and too much. \par}

The optimizer engine of Autopano is by default really smart as it’s what quickly stitches your panorama for an initial auto calibration. The problem solved by the optimizer can be seen as a curve fitting problem: given a curve model (e.g. y=a*X+b) find the parameters (a and b) that make the curve fit at best to a series of data points. In the context of panorama stitching, the model is the equation of projection of a 3D scene point to a 2D picture pixel and the parameters are the calibration unknowns and the orientation of each image.

The optimization settings you may decide to adjust will then affect the stitch quality, its seams, as well as the RMS value. Often, we think optimizing will solve our problem when in fact it can create additional problems.

\solution

{\large The RMS Value. \par}

RMS stands for Root Mean Square which in statistics is the square root mean of the squares of a sample - oh yee! In our context, RMS is a characteristic of a continuously varying function. Think of the RMS as a value representing the overall quality of the calculations between all control points found in the overlapping area of two images.

The lower your RMS value is, the better your stitch should be!

\imgA{1}{35/rms}

For the optimizer to calculate the RMS while improving your stitch, it needs a curve model and the data, the matched control points coming from the detector. Some points are good points but never perfectly accurate, while some are completely wrong. 

The optimizer will then perform a series of steps to first fit at best all control points, add a threshold for cleaning bad points, re-estimating the model parameters and then computing the final RMS calculation. The final RMS value is the mean size of these error segments, but it is not the quality of the visually stitched panorama.

\imgA{1}{35/fullopt}
\clearpage
{\large Optimization for 360 Rigs. \par}

The optimizer’s job is to find two main parameters which are the position of each image (yaw, pitch, roll) and the calibration of their focal length, lens distortion coefficients and centering of the optical axis. 

\imgA{1}{35/linkrms}

Let’s imagine you have a 360 rig with 4 GoPros, and dragged all the videos into AVP. Under the Control Points tab, check Advanced to see all Optimization settings affecting your control points.

\imgA{1}{35/advanced}

First under Scopes, set both Distortion and Offset to “Images” scope but keep Focal to “Pano” scope as all focal lengths are identical for all cameras. For a background stitching approach, set Distortion to Optimize 2nd Order from the dropdown and 3rd order for foreground stitching.

\imgA{1}{35/scopes}

When stitching, follow a mechanical optimization process. First, detect or add/remove control points a few times before selecting “Quick Optimize”. Repeat this step after finding enough control points. When satisfied, check clean “bad points” in order to fully optimize and move to the next pair of images.

\imgA{1}{35/quickopt}

{\large Too Much Optimization. \par}

One misconception is with the word “Optimizing”, hoping the engine will visually improve your stitch, when it fact it can make it worse.

When cleaning bad points too much, you will end up removing points which may have been bad but helped balance the equation making the stitch visually better despite the RMS value.


\clearpage
\end{fullwidth}
