\section{AE Comping}
\pagecolor{white}
\label{chap:51}
\begin{fullwidth}
\groupL{edit}

\problem

{\large You need to comp two stitched videos warped differently in After Effects. \par}

Compositing in After Effects is its own art form, as many tools can be used to achieve similar results. The goal is to perfectly blend one footage over another. AE is an alternative solution if stitching in Autopano is not enough to correct a few seams or if some external footage needs to be integrated into your panorama.

\solution

{\large Using Masks. \par}

Using the pen tool to create a mask over a static shot is the fastest way to composite an object into your panorama. For moving shots, first motion track using a null object and link your mask to it for \textbf{\nameref{chap:50}} with Mocha. Any green screen footage will benefit from \textbf{\nameref{chap:53}} techniques much faster than rotoscoping, but results tend to be a bit rushed compared to rotoscoping.

\imgB{.5}{51/base}{51/tocomp}

Try to create a large mask with points following along the architecture of the distant background that contains the object or subject to hide unfixed seams in AVP. Sometimes, it is just enough. For moving shots, motion track using the AE tracking points or Mocha. Depending on your panorama, a large mask may create more difficulties to blend than a tight mask around the outlines of your object or subject. 

\imgB{.5}{51/maskbefore}{51/maskafter}

When satisfied with your mask and its movement over time (see \textbf{\nameref{chap:50}} for fast tracking), compare RGB histograms between the footage being comped and the base footage. Levels is the best plugin to correct exposure in After Effects and has the RGB histogram that is needed. Sometimes it is enough to bring the mid light up or down to lighten or darken the shot that needs to be comped. Keep the edge of your mask sharp to better gauge how much gamma adjustment is needed for a nice blending of the colors.

\imgB{.5}{51/levelsbefore}{51/levelsafter}

Press M on the selected layer to bring up the Mask parameters. Start by expanding the mask by 2 to 5 pixels, and then increase the feather of its edges. You can see in realtime what values are best for blending the comp into the base panorama. 

\imgB{.5}{51/feather}{51/feathermask}

{\large Blending with different lens distortion. \par}

Compositing footage in a 360 panorama gets really tricky quickly due to lens distortion and warping. To fix parallax seams, render your stitched panorama as a tiff sequence. Render all the rest of your cameras as well with the same render settings, except without blending, just the same warping and positioning. 

{\bfseries Using the mesh warp tool for static shots}
\\
Bring the mesh warp onto your mask and add additional rows and columns to adjust the warping. The mesh is based on the entire footage and not the mask shape you created. The mesh nearby the mask shape can be edited better with more columns and rows. Start adjusting the verticals without touching your horizon. Re-adjust your mask shape and feather until both the background and your mask blend nicely together.

{\bfseries Using the optics compensation for moving shots}
\\
When working with moving shots, if your mask is linked to a motion-tracked null object or your shape and data copied from \textbf{\nameref{chap:50}}, adjust your optics compensation slightly. If shooting with fisheye lens, reverse the compensation to defish the distortion. 



\clearpage
\end{fullwidth}